## 1.1 总体设计

行程计算系统的总体结构包括两部分，即航班查询服务和数据更新服务。

<img src="C:\Users\29393\AppData\Roaming\Typora\typora-user-images\image-20220629130404346.png" alt="image-20220629130404346" style="zoom: 67%;" />

航班查询服务主要为行程的搜索提供查询服务，当有用户查询行程时，航班查询服务器首先解析用户的输入请求，并根据用户输入的 O-D 信息、时刻信息等进行行程的搜索计算，并将符合用户查询条件的行  程结果集合返回给查询用户；数据更新服务作为与其他系统交互的接口，主要为行程的生成提供基础数据更新服务，包括：从航班控制系统（FLT， flight system）接收直飞航班的信息更新，从航班库存系统（INV，inventory system）接收舱位可利用的状态更新，及从运价计算系统（PRIC， pricing system）接收里程制运价的相关信息。  

行程计算系统的总体计算流程主要包括以下 4个步骤。

1. **数据预处理。**为提高行程计算过程中联程航班的构建效率，首先进行数据预处理，根据全市场（或特定市场）的商营直飞航班信息构建航班网络图。
2. **请求输入。**用户输入自己的行程需求，包括出发城市（机场） 、目的城市（机场） 、出发日期等必选项，同时也可以输入偏好条件，包括喜好或厌恶的航空公司、喜好或厌恶的中转机场、最晚起飞时间、中转次数、转机时间等。客户端根据用户输入的选项，生成用户行程请求参数，并发送给航班查询服务器。
3. **行程搜索。**根据用户输入的请求信息，构建多因素约束，应用双向搜索算法进行行程搜索计算。
4. **结果筛选。**对搜索到的行程集合再次进行综合打分，将满足用户需求的较优结果返回给用户。  

## 1.2 航班网络图

航班网络图不同于航线网络图，是基于直达航班进行构建的。通过遍历直达航班信息，根据直达航班的起飞机场、起飞城市、到达机场和到达城市构建航班网络图。航班网络图中的每条边表示 1 个直达航班，边与边之间的连接点表示机场。如果两点之间存在 1个直达航班，则在两点之间增加 1 条边，如果两点之间存在多个直达航班则会存在多条边。

<img src="C:\Users\29393\AppData\Roaming\Typora\typora-user-images\image-20220629130738223.png" alt="image-20220629130738223" style="zoom:67%;" />

## 1.3 多因素双向搜索方法  

<img src="C:\Users\29393\AppData\Roaming\Typora\typora-user-images\image-20220629130924399.png" alt="image-20220629130924399" style="zoom:67%;" />

该方法的主要步骤可以概括如下。

1. **扩展**
   根据用户输入的出发地 O 和目的地 D 从航班网络图的两端进行扩展，即分别以出发地和目的地为初始节点在航班网络图上进行边的搜索，找到以出发地为初始节点的所有航班经过的路径集合 Li，以及以目的地为初始节点的所有航班经过的路径集合 Ri， Li 和Ri 中存储历史路径的航班信息和机场信息。逐级扩展后将会得到分别以出发地和目的地为初始节点的两个行程集合 L = {Li}和 R = {Ri}。
2. **剪枝**
   所谓剪枝即删除行程集合 L 和 R 中较差的行程点，目的是减少不必要的扩展，从而提高搜索效率，剪枝后生成行程集合 L′和 R′。剪枝时需要删除不合理的中转点，减少下次扩展时的搜索空间。剪枝过程要尽量避免降低结果的丰富度。剪枝过程发生在每次扩展后，需要对两个方向生成的行程分别进行剪枝，如果一个方向生成的行程已经很差则可以删除。剪枝过程即多因素约束过程，实践中可考虑下列几个因素。    
   - **距离**
     当扩展点的里程超过里程制运价中关于中转里程的限制时则删除该点。为了得到更优的行程结果，对于里程的限制也可以借鉴经验数据，例如可以通过限制绕飞率对中转里程进行限制，实践中绕飞率一般不超过 2.5。
   - **中转次数**
     主要对行程超过一定中转次数的点进行删减。中转次数的限制可以根据经验数据进行设置，例如一个完整行程的中转次数一般不会超过 5 次。如果两地之间存在直飞航班，则多次中转的联程航班权重较低。
   - **时间**
     中转机场的最短衔接时间（MCT， minimum connecting time）限制，低于该时长将无法在相应机场实现中转。另外也可以对旅行总时间设置限制要求。
   - **运价规则**
     在里程制运价规则中对旅行方向进行了规定，只有满足旅行方向的扩展点才被保留。另外运价规则还对航班的属性进行了限制，例如可以限制整个行程的航班不允许存在航班经停。
   - **其他**
     包括航空联盟限制等，不再赘述。  
3. **交集**
   将两个方向的行程集合 L′和 R′的扩展点取交集，
   如果存在交集则可以组成完整的行程 P = {Pi（} Pi 存储
   了完整的行程路径信息） 。
4. **检查**
   对已经得到的行程 P 进行检查，检查的目的是对完整行程进行可用性的再度评估及取舍，保证结果集合的多样性和便捷性，同时关注价格，检查后生成行程集合 P′。首先可以根据需要保留极端最优行程，如价格最低、旅行时间最短、所有直飞航班等；其次对所有行程进行综合打分，计算行程的分值并按照分值由高到低存储，删除综合打分低的行程。典型的打分项包括：对舱位可利用状态打分（CAV Score， cabin availability score） 、对行程的总旅行时间打分（TFTScore， totalflight time score） 、对行程的中转次数打分（ConnectionScore） 、对行程中航空公司之间的关系打分（AllianceScore）等，汇总后获得总分值。
5. **判断是否需要进一步扩展**
   如果已经搜索到的行程数量还没有达到返回结果的数量限制，即|P′| < N，则需要进一步进行扩展；如果达到了返回结果的数量限制，则需要判断是否需要进一步扩展，如果进一步扩展后最优行程的分值小于已经得到的最差行程的分值，则停止扩展。为了尽量降低图的发散，每次扩展都选择邻居点较少的一边进行。

## 1.4 方法模型

多因素双向搜索方法描述可以简化为如下数学模型。

航班网络图抽象为有向图 G = <V， E>，其中： V ={v1， v2， …， vn}为节点集， n 为网络图中节点的个数； E =
{e1， e2， …， em}为边集， m 为网络图中边的条数。

**正向搜索：**指定 O = v1 为搜索起点，宽度遍历其作为出度点的边，然后再以得到的边集查找对应的入度
点，这样就得到路径集 L1 = {v1e1v2， v1e2v2， v1e3v3， …}，然后以路径集中各路径终点为起点重复以上步骤，并在查找过程中删除有重复点的路径，得到路径集 L2 ={v1e1v2e4v4， v1e2v2e4v4， v1e3v3e5v4， …}。重复以上步骤A 次，可以得到路径集合 L = {L1， L2， …， LA}。反向搜索：指定 D = vn 为搜索起点，进行反向遍历，最终得到路径集合 R = {R1， R2， …， RA}。基于 O、D 两个端点，同时分别执行正向搜索和反向搜索，可得到路径集 L 和R，设定 VL∈L 为 L 的路径终点集合， VR∈R 为 R 的路径终点集合，如果 VL∩VR≠ ，则可以获得完整行程 P。
**多因素约束条件：**在双向搜索过程中，每步均通过多因素约束进行剪枝，以控制发散。



1. 距离约束条件

   针对 O、D，查询其里程制运价中总里程限制，设为 M，则约束条件如下

   <img src="C:\Users\29393\AppData\Roaming\Typora\typora-user-images\image-20220629131939224.png" alt="image-20220629131939224" style="zoom: 67%;" />

   式中： g =〈Vg， Eg〉表示搜索过程中产生的 1 条路径； de表示路径中边 e 的里程。

   绕飞率约束一般限制为 2.5，则

   <img src="C:\Users\29393\AppData\Roaming\Typora\typora-user-images\image-20220629132024525.png" alt="image-20220629132024525" style="zoom: 67%;" />

   式中 Zg 表示路径 g 的两个端点间的商营直飞里程。

2. 中转次数约束条件

   中转次数一般不超过 5 次，即

   <img src="C:\Users\29393\AppData\Roaming\Typora\typora-user-images\image-20220629132110522.png" alt="image-20220629132110522" style="zoom:67%;" />

   式中 Hg 表示路径 g 上所有节点的数量。

3. 时间约束条件

   设定 te 和 tv 表示路径 g 上 e 边的飞行时长和两个衔接边在 v 点上的衔接时长， Cv 表示 v 点的 MCT 时间限制， T 表示 O、D 间总旅行时长限制，则  

   <img src="C:\Users\29393\AppData\Roaming\Typora\typora-user-images\image-20220629132207205.png" alt="image-20220629132207205" style="zoom:67%;" />

​		此外还可以根据运价规则、航空联盟等设置约束条件，以尽快达到剪枝的目		的。在上述约束条件的基础上，针对完整行程集合 P，确定打分规则进行评		分筛选，则路径 g 的评分公式如下  

<img src="C:\Users\29393\AppData\Roaming\Typora\typora-user-images\image-20220629132256926.png" alt="image-20220629132256926" style="zoom:67%;" />

​		式中： Sg 为路径 g 的总分数； sq 为路径 g 的第 q 项分数； Q 为评分项。  